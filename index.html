<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¸ç”Ÿæ¯æ—¥ä¸­æ–‡æ¢éšª</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #a29bfe;
            --success: #00b894;
            --warning: #fdcb6e;
            --bg: #f9f9fb;
        }

        body {
            font-family: "Microsoft JhengHei", "æ•™è‚²éƒ¨æ¨™æº–æ¥·æ›¸", sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            color: #2d3436;
        }

        /* é ‚éƒ¨å°èˆª */
        nav {
            width: 100%; background: white; padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around;
            position: sticky; top: 0; z-index: 100;
        }

        nav button {
            border: none; background: none; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; color: #636e72;
            padding: 10px 20px; border-radius: 20px;
        }

        nav button.active { background: var(--primary); color: white; }

        /* å¡ç‰‡è¨­è¨ˆ */
        .container { width: 95%; max-width: 600px; padding: 20px; }
        .word-section { margin-bottom: 30px; }
        .section-header { font-size: 1.2rem; margin: 15px 0; color: var(--primary); font-weight: bold; }

        .word-card {
            background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 10px;
        }

        .char-row { display: flex; align-items: center; gap: 20px; }
        .big-char { font-size: 60px; color: var(--primary); cursor: pointer; }
        
        .vocab-list { display: flex; flex-direction: column; gap: 8px; }
        .vocab-item { font-size: 1.1rem; line-height: 1.4; color: #444; }
        .vocab-item span { color: #888; font-size: 0.9rem; margin-right: 5px; }

        /* éŠæˆ²æ¨¡å¼æ¨£å¼ */
        #game-area { text-align: center; display: none; }
        .quiz-card {
            background: white; border-radius: 25px; padding: 30px;
            box-shadow: 0 10px 30px rgba(108, 92, 231, 0.2); margin-top: 20px;
        }
        .question { font-size: 1.8rem; margin-bottom: 30px; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-btn {
            background: #f1f2f6; border: 2px solid #dfe4ea;
            padding: 15px; border-radius: 15px; font-size: 1.3rem;
            cursor: pointer; transition: 0.2s;
        }
        .option-btn:hover { background: var(--secondary); color: white; }

        .score-display { font-size: 1.2rem; margin-bottom: 10px; color: var(--success); font-weight: bold; }

        .loading-spinner { color: #999; font-style: italic; }
    </style>
</head>
<body>

    <nav>
        <button id="btn-learn" class="active" onclick="showTab('learn')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
        <button id="btn-game" onclick="showTab('game')">ğŸ® æŒ‘æˆ°éŠæˆ²</button>
    </nav>

    <div id="learn-tab" class="container">
        <h2 id="today-date"></h2>
        <div class="word-section" id="new-words-list">
            <div class="section-header">â­ ä»Šæ—¥æ–°å–®å­—</div>
        </div>
        <div class="word-section" id="review-words-list">
            <div class="section-header">ğŸ“š è¤‡ç¿’å–®å­—</div>
        </div>
    </div>

    <div id="game-tab" class="container" style="display:none;">
        <div id="game-area">
            <div class="score-display">ç²å¾—æ˜Ÿæ˜Ÿï¼š<span id="stars">0</span> â­</div>
            <div class="quiz-card" id="quiz-content">
                <!-- éŠæˆ²å…§å®¹å‹•æ…‹ç”¢ç”Ÿ -->
            </div>
        </div>
    </div>

    <script>
        let dailyWords = [];
        let score = 0;
        const synth = window.speechSynthesis;

        // åˆå§‹åŒ–
        async function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('today-date').innerText = `ğŸ“… ${today}`;

            try {
                const res = await fetch('schedule.json');
                const schedule = await res.json();
                dailyWords = schedule[today] || [];

                if (dailyWords.length > 0) {
                    renderLearning();
                } else {
                    document.body.innerHTML += "<h1>ä»Šå¤©æ²’æœ‰å®‰æ’èª²ç¨‹å–”ï¼</h1>";
                }
            } catch (e) {
                alert("æ‰¾ä¸åˆ° schedule.json æª”æ¡ˆï¼");
            }
        }

        // åˆ‡æ›åˆ†é 
        function showTab(tab) {
            document.getElementById('learn-tab').style.display = tab === 'learn' ? 'block' : 'none';
            document.getElementById('game-tab').style.display = tab === 'game' ? 'block' : 'none';
            document.getElementById('btn-learn').classList.toggle('active', tab === 'learn');
            document.getElementById('btn-game').classList.toggle('active', tab === 'game');
            if(tab === 'game') startNewQuiz();
        }

        // å¾èŒå…¸ API æŠ“å–èªè©
        async function fetchVocab(char) {
            try {
                const res = await fetch(`https://www.moedict.tw/api/v2/index/${char}`);
                const data = await res.json();
                // éæ¿¾ä¸¦åˆ†é¡èªè©
                const allVocabs = data.relates || [];
                const v2 = allVocabs.filter(v => v.length === 2).slice(0, 3);
                const v3 = allVocabs.filter(v => v.length === 3).slice(0, 1);
                const v4 = allVocabs.filter(v => v.length >= 4).slice(0, 1);
                return { v2, v3, v4 };
            } catch (e) {
                return { v2: [], v3: [], v4: [] };
            }
        }

        // æ¸²æŸ“å­¸ç¿’å¡ç‰‡
        async function renderLearning() {
            for (let i = 0; i < dailyWords.length; i++) {
                const char = dailyWords[i];
                const isNew = i < 2;
                const targetList = document.getElementById(isNew ? 'new-words-list' : 'review-words-list');
                
                const card = document.createElement('div');
                card.className = 'word-card';
                card.innerHTML = `<div class="loading-spinner">æ­£åœ¨å¹« ${char} æ‰¾èªè©...</div>`;
                targetList.appendChild(card);

                // éåŒæ­¥ç²å–èªè©
                const vocabs = await fetchVocab(char);
                
                card.innerHTML = `
                    <div class="char-row">
                        <div class="big-char" onclick="speak('${char}')">${char}</div>
                        <div class="vocab-list">
                            ${vocabs.v2.map(v => `<div class="vocab-item" onclick="speak('${v}')"><span>â—</span>${v}</div>`).join('')}
                            ${vocabs.v3.map(v => `<div class="vocab-item" onclick="speak('${v}')"><span>â—</span>${v}</div>`).join('')}
                            ${vocabs.v4.map(v => `<div class="vocab-item" onclick="speak('${v}')"><span>â—</span>${v}</div>`).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // éŠæˆ²é‚è¼¯ï¼šé€ è©å¤§ç‹
        async function startNewQuiz() {
            const quizContainer = document.getElementById('quiz-content');
            quizContainer.innerHTML = "ğŸ² é¡Œç›®ç”¢ç”Ÿä¸­...";

            // éš¨æ©Ÿé¸ä¸€å€‹ä»Šå¤©çš„å­—
            const correctChar = dailyWords[Math.floor(Math.random() * dailyWords.length)];
            const vocabs = await fetchVocab(correctChar);
            const allOptions = [vocabs.v2, vocabs.v3, vocabs.v4].flat();

            if (allOptions.length === 0) { // å¦‚æœé€™å€‹å­—æ²’èªè©ï¼Œå†è©¦ä¸€æ¬¡
                startNewQuiz();
                return;
            }

            const targetVocab = allOptions[Math.floor(Math.random() * allOptions.length)];
            const questionText = targetVocab.replace(correctChar, "ï¼ˆ ï¼Ÿ ï¼‰");

            // æº–å‚™å¹²æ“¾é¸é …
            let distractors = dailyWords.filter(c => c !== correctChar)
                                      .sort(() => 0.5 - Math.random())
                                      .slice(0, 3);
            
            const finalOptions = [correctChar, ...distractors].sort(() => 0.5 - Math.random());

            quizContainer.innerHTML = `
                <div class="question">å“ªå€‹å­—å¯ä»¥çµ„æˆï¼š<br><b>${questionText}</b></div>
                <div class="options">
                    ${finalOptions.map(opt => `
                        <button class="option-btn" onclick="checkAnswer('${opt}', '${correctChar}')">${opt}</button>
                    `).join('')}
                </div>
            `;
        }

        function checkAnswer(selected, correct) {
            if (selected === correct) {
                score += 1;
                document.getElementById('stars').innerText = score;
                speak("ç­”å°äº†ï¼ä½ çœŸæ£’");
                alert("ğŸ‰ å¤ªè°æ˜äº†ï¼ç­”å°å›‰ï¼");
            } else {
                speak("å†è©¦ä¸€æ¬¡çœ‹çœ‹");
                alert("âŒ å“å‘€ï¼Œå·®ä¸€é»é»ï¼Œå†è©¦ä¸€æ¬¡ï¼");
            }
            startNewQuiz();
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            utter.rate = 0.8;
            synth.speak(utter);
        }

        init();
    </script>
</body>
</html>
