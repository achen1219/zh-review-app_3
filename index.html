<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹å°ä¸­æ–‡å­¸ç¿’å°è€å¸«</title>
    <style>
        :root { --p: #6c5ce7; --s: #a29bfe; --bg: #f9f9fb; --text: #2d3436; }
        body { font-family: "Microsoft JhengHei", "æ•™è‚²éƒ¨æ¨™æº–æ¥·æ›¸", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; color: var(--text); }
        
        /* å°è¦½åˆ— */
        nav { background: white; padding: 12px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        nav button { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; background: #f1f2f6; color: #747d8c; transition: 0.3s; }
        nav button.active { background: var(--p); color: white; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        
        /* å–®å­—å¡ç‰‡ */
        .word-card { background: white; border-radius: 25px; padding: 25px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); text-align: left; position: relative; }
        .tag { padding: 5px 12px; border-radius: 10px; color: white; font-size: 0.85rem; position: absolute; top: 15px; left: 15px; font-weight: bold; }
        
        .char-section { text-align: center; margin-bottom: 15px; }
        .big-char { font-size: 100px; color: var(--p); cursor: pointer; font-weight: bold; display: inline-block; line-height: 1; }
        .char-def { background: #f0f0ff; padding: 10px 15px; border-radius: 12px; font-size: 1rem; color: #555; margin: 10px 0; border-left: 4px solid var(--p); line-height: 1.5; }

        /* èªè©åˆ—è¡¨ */
        .vocab-list { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 15px; }
        .vocab-group { display: flex; flex-direction: column; gap: 12px; }
        .vocab-item-box { background: #fafafa; border-radius: 15px; padding: 12px; transition: 0.2s; cursor: pointer; border: 1px solid transparent; }
        .vocab-item-box:hover { border-color: var(--s); background: #fff; }
        .vocab-word { font-size: 1.4rem; font-weight: bold; color: #2d3436; margin-bottom: 4px; display: block; }
        .vocab-def { font-size: 0.95rem; color: #636e72; line-height: 1.4; }

        #game-tab { display: none; }
        .quiz-card { background: white; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .opt-btn { width: 100%; padding: 18px; margin: 10px 0; font-size: 1.8rem; border: 2px solid #f1f2f6; border-radius: 15px; background: white; cursor: pointer; font-weight: bold; }

        .loading-text { text-align: center; color: #a4b0be; margin-top: 50px; font-style: italic; }
    </style>
</head>
<body>

<nav>
    <button id="nav-learn" class="active" onclick="switchTab('learn')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
    <button id="nav-game" onclick="switchTab('game')">ğŸ® æŒ‘æˆ°éŠæˆ²</button>
</nav>

<div class="container">
    <h2 id="date-info" style="color:#57606f; text-align:center; margin-bottom:20px;">ğŸ“… æº–å‚™ä¸­...</h2>
    
    <div id="learn-tab">
        <div id="word-list" class="loading-text">ğŸ­ æ­£åœ¨å‘å­—å…¸è€å¸«å€Ÿæ›¸ï¼Œè«‹ç¨å€™...</div>
    </div>

    <div id="game-tab">
        <div class="quiz-card">
            <div id="score" style="font-size: 1.2rem; color: #ffa502; font-weight: bold; margin-bottom: 10px;">â­ æ˜Ÿæ˜Ÿæ•¸é‡ï¼š0</div>
            <div id="q-text" style="font-size: 2rem; margin: 30px 0; line-height: 1.4;"></div>
            <div id="q-options"></div>
        </div>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    let score = 0;
    let currentDayWords = [];
    let wordDetails = {}; // å„²å­˜å­—è©è©³è§£

    async function init() {
        try {
            const response = await fetch('schedule.json?t=' + Date.now());
            const scheduleData = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const dateKey = scheduleData[today] ? today : Object.keys(scheduleData)[0];
            currentDayWords = scheduleData[dateKey];
            document.getElementById('date-info').innerText = "ğŸ“… " + dateKey + " ç·´ç¿’";
            renderLearning();
        } catch (e) {
            document.getElementById('word-list').innerHTML = "âŒ è®€å– schedule.json å¤±æ•—ã€‚";
        }
    }

    // æŠ“å–èŒå…¸è©³è§£ (åŒ…å«è§£é‡‹èˆ‡æ­£ç¢ºä¾‹è©)
    async function fetchFullData(char) {
        if (wordDetails[char]) return wordDetails[char];

        const proxy = "https://api.allorigins.win/get?url=";
        const target = `https://www.moedict.tw/a/${encodeURIComponent(char)}.json`;
        
        try {
            const res = await fetch(proxy + encodeURIComponent(target));
            const json = await res.json();
            const data = JSON.parse(json.contents);
            
            // è§£æè³‡æ–™
            const entry = data.h[0];
            const charDef = entry.d[0].f.replace(/\[|\]/g, ''); // å–ç¬¬ä¸€å€‹å®šç¾©
            
            // å¾å®šç¾©çš„ä¾‹å­æˆ–æ˜¯ç›¸é—œè©ä¸­æ‰¾èªè©
            let vocabs = [];
            entry.d.forEach(d => {
                if (d.e) {
                    d.e.forEach(example => {
                        // æå– 2-4 å­—çš„è©
                        const match = example.match(/[\u4e00-\u9fa5]{2,4}/g);
                        if (match) vocabs.push(...match);
                    });
                }
            });
            
            // å¦‚æœä¾‹å¥æ²’è©ï¼Œå°±å¾ relates æ‰¾
            if (vocabs.length < 2 && data.relates) vocabs.push(...data.relates);

            // éæ¿¾æ‰å–®å­—ï¼Œä¸¦å»é‡
            vocabs = [...new Set(vocabs.filter(v => v.includes(char) && v.length >= 2))].slice(0, 3);

            // æŠ“å–é€™äº›èªè©çš„ç°¡å–®è§£é‡‹ (é€™æ­¥æ¯”è¼ƒè€—æ™‚ï¼Œæˆ‘å€‘å…ˆåšç°¡å–®è™•ç†)
            const result = {
                char: char,
                def: charDef,
                vocabs: vocabs.map(v => ({ word: v, def: "é»æ“Šç™¼éŸ³ç·´ç¿’" })) 
            };
            
            wordDetails[char] = result;
            return result;
        } catch (e) {
            return { char: char, def: "å¸¸è¦‹å­—", vocabs: [{word: char+"å¤©", def: ""}] };
        }
    }

    async function renderLearning() {
        const list = document.getElementById('word-list');
        list.innerHTML = "";
        
        for (let i = 0; i < currentDayWords.length; i++) {
            const char = currentDayWords[i];
            const isNew = i < 2;
            const data = await fetchFullData(char);

            const card = document.createElement('div');
            card.className = 'word-card';
            card.innerHTML = `
                <span class="tag" style="background:${isNew ? '#ff7675':'#55efc4'}">${isNew ? 'âœ¨ æ–°å–®å­—' : 'ğŸ”„ æº«ç¿’ä¸­'}</span>
                <div class="char-section">
                    <div class="big-char" onclick="speak('${char}')">${char}</div>
                    <div class="char-def"><b>æ„æ€ï¼š</b>${data.def}</div>
                </div>
                <div class="vocab-list">
                    <div class="vocab-group">
                        ${data.vocabs.map(v => `
                            <div class="vocab-item-box" onclick="speak('${v.word}')">
                                <span class="vocab-word">${v.word}</span>
                                <span class="vocab-def">é»æ“Šè½ç™¼éŸ³</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            list.appendChild(card);
        }
    }

    function switchTab(tab) {
        document.getElementById('learn-tab').style.display = tab === 'learn' ? 'block' : 'none';
        document.getElementById('game-tab').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('nav-learn').className = tab === 'learn' ? 'active' : '';
        document.getElementById('nav-game').className = tab === 'game' ? 'active' : '';
        if(tab === 'game') initGame();
    }

    async function initGame() {
        const qText = document.getElementById('q-text');
        const qOpts = document.getElementById('q-options');
        qText.innerText = "ğŸ² é¡Œç›®æ­£åœ¨é£›éä¾†...";
        qOpts.innerHTML = "";

        const correctChar = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
        const data = await fetchFullData(correctChar);
        
        if (data.vocabs.length === 0) { initGame(); return; }

        const target = data.vocabs[Math.floor(Math.random() * data.vocabs.length)].word;
        qText.innerHTML = `å“ªå€‹å­—å¯ä»¥çµ„æˆï¼š<br><b style="font-size:3rem; color:var(--p);">${target.replace(correctChar, " â–¡ ")}</b>`;

        let options = [correctChar];
        while(options.length < 4) {
            let r = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === correctChar) {
                    score++;
                    document.getElementById('score').innerText = "â­ æ˜Ÿæ˜Ÿæ•¸é‡ï¼š" + score;
                    speak("ç­”å°äº†ï¼Œå¦³å¥½å²å®³ï¼");
                    initGame();
                } else {
                    speak("å†è©¦ä¸€æ¬¡");
                    btn.style.background = "#ffeaa7";
                }
            };
            qOpts.appendChild(btn);
        });
    }

    function speak(t) {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-TW';
        u.rate = 0.8;
        synth.speak(u);
    }

    init();
</script>
</body>
</html>
