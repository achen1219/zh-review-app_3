<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å…’çš„ä¸­æ–‡æ¢éšª</title>
    <style>
        :root { --p: #6c5ce7; --s: #a29bfe; --bg: #f9f9fb; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
        nav { background: white; padding: 12px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        nav button { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; background: #f1f2f6; color: #747d8c; }
        nav button.active { background: var(--p); color: white; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .word-card { background: white; border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); text-align: left; position: relative; }
        .big-char { font-size: 90px; color: var(--p); cursor: pointer; font-weight: bold; text-align: center; display: block; line-height: 1.1; margin: 15px 0; }
        
        .vocab-list { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 15px; min-height: 50px; }
        .vocab-item { font-size: 1.3rem; margin: 10px 0; color: #2d3436; cursor: pointer; display: flex; align-items: center; }
        .vocab-item:before { content: "ğŸˆ"; margin-right: 10px; font-size: 1rem; }
        
        .tag { padding: 5px 12px; border-radius: 10px; color: white; font-size: 0.8rem; position: absolute; top: 15px; left: 15px; font-weight: bold; }
        
        #game-tab { display: none; }
        .opt-btn { width: 100%; padding: 18px; margin: 10px 0; font-size: 1.8rem; border: 2px solid #f1f2f6; border-radius: 15px; background: white; cursor: pointer; font-weight: bold; }

        .retry-btn { padding: 5px 10px; font-size: 0.8rem; background: #eee; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    </style>
</head>
<body>

<nav>
    <button id="nav-learn" class="active" onclick="showTab('learn')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
    <button id="nav-game" onclick="showTab('game')">ğŸ® æŒ‘æˆ°éŠæˆ²</button>
</nav>

<div class="container">
    <h2 id="date-info" style="color:#57606f; text-align:center;">é€£ç·šä¸­...</h2>
    <div id="learn-tab">
        <div id="word-list" style="color:#a4b0be; text-align:center; margin-top:50px;">æ­£åœ¨åŠªåŠ›æ¬é‹èªè©ä¸­...</div>
    </div>
    <div id="game-tab">
        <div style="background: white; padding: 30px; border-radius: 25px; text-align: center;">
            <div id="score" style="font-size: 1.1rem; color: #ffa502; font-weight: bold;">æ”¶é›†æ˜Ÿæ˜Ÿï¼š0 â­</div>
            <div id="q-text" style="font-size: 2rem; margin: 25px 0;"></div>
            <div id="q-options"></div>
        </div>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    let score = 0;
    let currentDayWords = [];
    let vocabCache = {};

    async function init() {
        try {
            const response = await fetch('schedule.json?t=' + Date.now());
            const scheduleData = await response.json();
            const today = new Date().toISOString().split('T')[0];
            const dateKey = scheduleData[today] ? today : Object.keys(scheduleData)[0];
            currentDayWords = scheduleData[dateKey];
            document.getElementById('date-info').innerText = "ğŸ“… " + dateKey;
            renderAllCards();
        } catch (e) {
            document.getElementById('word-list').innerHTML = "âŒ ç„¡æ³•è®€å– schedule.jsonï¼Œè«‹æª¢æŸ¥æª”åã€‚";
        }
    }

    // æ ¸å¿ƒé€£ç·šé‚è¼¯ï¼šå˜—è©¦å¤šç¨®æ–¹å¼ç²å–è³‡æ–™
    async function fetchVocab(char) {
        if (vocabCache[char]) return vocabCache[char];

        const tryFetch = async (url) => {
            const res = await fetch(url);
            if (!res.ok) throw new Error();
            const data = await res.json();
            // è™•ç† allorigins çš„ç‰¹æ®Šæ ¼å¼
            const finalData = data.contents ? JSON.parse(data.contents) : data;
            return finalData.relates || [];
        };

        const charEncoded = encodeURIComponent(char);
        const moedictUrl = `https://www.moedict.tw/api/v2/index/${charEncoded}`;
        
        // å˜—è©¦åˆ—è¡¨ï¼š1. ç›´æ¥é€£ 2. Proxy A 3. Proxy B
        const attempts = [
            moedictUrl,
            `https://api.allorigins.win/get?url=${encodeURIComponent(moedictUrl)}`,
            `https://corsproxy.io/?${encodeURIComponent(moedictUrl)}`
        ];

        for (let url of attempts) {
            try {
                const list = await tryFetch(url);
                if (list.length > 0) {
                    const result = {
                        v2: list.filter(v => v.length === 2).slice(0, 3),
                        v3: list.filter(v => v.length === 3).slice(0, 1),
                        v4: list.filter(v => v.length >= 4).slice(0, 1)
                    };
                    vocabCache[char] = result;
                    return result;
                }
            } catch (e) { continue; }
        }

        // å¦‚æœå…¨éƒ¨å¤±æ•—ï¼Œå•Ÿå‹•ã€Œæ™ºæ…§é€ è©å‚™æ¡ˆã€ï¼Œä¸å†å‡ºç¾ XXå­
        return getSmartFallback(char);
    }

    function getSmartFallback(char) {
        // é‡å°å¸¸è¦‹å­—æ ¹çš„æ™ºæ…§çµ„åˆ
        const common = {
            "å«©": ["å«©ç¶ ", "å«©è‘‰", "å¬Œå«©"],
            "çŒ´": ["çŒ´å­", "å°çŒ´", "è€çŒ´æˆ²"],
            "æŠ«": ["æŠ«é¢¨", "æŠ«ä¸Š", "æŠ«æ˜Ÿæˆ´æœˆ"],
            "ä¿¡": ["å¯«ä¿¡", "ä¿¡å¿ƒ", "ä¿¡ç”¨"],
            "å¯¦": ["èª å¯¦", "æœå¯¦", "å¯¦é©—"],
            "éµ": ["éµè·¯", "é‹¼éµ", "éµé–€"],
            "åˆ©": ["åˆ©æ¯", "ä¾¿åˆ©", "å‹åˆ©"],
            "åº·": ["å¥åº·", "åº·å¾©", "å®‰åº·"]
        };
        return { 
            v2: common[char] || [char + "å¤©", "å¤§" + char, char + "è‰²"], 
            v3: [], 
            v4: [] 
        };
    }

    async function renderAllCards() {
        const container = document.getElementById('word-list');
        container.innerHTML = "";
        
        for (let i = 0; i < currentDayWords.length; i++) {
            const char = currentDayWords[i];
            const cardId = `card-${i}`;
            const isNew = i < 2;

            const card = document.createElement('div');
            card.className = 'word-card';
            card.innerHTML = `
                <span class="tag" style="background:${isNew ? '#ff7675':'#55efc4'}">${isNew ? 'âœ¨ æ–°æŒ‘æˆ°' : 'ğŸ”„ æº«ç¿’'}</span>
                <div class="big-char" onclick="speak('${char}')">${char}</div>
                <div class="vocab-list" id="${cardId}">
                    <span style="color:#ccc; font-size:0.9rem;">æ­£åœ¨æ‰¾å¥½è©...</span>
                </div>
            `;
            container.appendChild(card);

            // éåŒæ­¥åŠ è¼‰èªè©ï¼Œä¸å¡ä½ç•«é¢
            updateCardVocab(char, cardId);
        }
    }

    async function updateCardVocab(char, elementId) {
        const voc = await fetchVocab(char);
        const el = document.getElementById(elementId);
        if (!el) return;
        
        const all = [...voc.v2, ...voc.v3, ...voc.v4];
        if (all.length > 0) {
            el.innerHTML = all.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('');
        } else {
            el.innerHTML = `<div class="vocab-item" onclick="speak('${char}å¤©')">${char}å¤©</div>`;
        }
    }

    function showTab(tab) {
        document.getElementById('learn-tab').style.display = tab === 'learn' ? 'block' : 'none';
        document.getElementById('game-tab').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('nav-learn').className = tab === 'learn' ? 'active' : '';
        document.getElementById('nav-game').className = tab === 'game' ? 'active' : '';
        if(tab === 'game') initGame();
    }

    async function initGame() {
        const qText = document.getElementById('q-text');
        const qOpts = document.getElementById('q-options');
        qText.innerText = "ğŸ² æº–å‚™ä¸­...";
        qOpts.innerHTML = "";

        const correctChar = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
        const voc = await fetchVocab(correctChar);
        const allVoc = [...voc.v2, ...voc.v3, ...voc.v4];

        if(allVoc.length === 0) { initGame(); return; }

        const target = allVoc[Math.floor(Math.random() * allVoc.length)];
        qText.innerHTML = `é€™å€‹å­—å¯ä»¥çµ„æˆï¼š<br><b style="font-size:2.8rem; color:var(--p);">${target.replace(correctChar, " â–¡ ")}</b>`;

        let options = [correctChar];
        while(options.length < 4) {
            let r = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === correctChar) {
                    score++;
                    document.getElementById('score').innerText = "æ”¶é›†æ˜Ÿæ˜Ÿï¼š" + score + " â­";
                    speak("ç­”å°äº†");
                    initGame();
                } else {
                    speak("å†è©¦ä¸€æ¬¡");
                    btn.style.background = "#ffeaa7";
                }
            };
            qOpts.appendChild(btn);
        });
    }

    function speak(t) {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-TW';
        u.rate = 0.8;
        synth.speak(u);
    }

    init();
</script>
</body>
</html>
