<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å…’çš„ä¸­æ–‡æ¢éšª</title>
    <style>
        :root { --p: #6c5ce7; --s: #a29bfe; --bg: #f9f9fb; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; text-align: center; }
        nav { background: white; padding: 15px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        nav button { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; background: #f1f2f6; color: #747d8c; }
        nav button.active { background: var(--p); color: white; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .word-card { background: white; border-radius: 25px; padding: 30px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); text-align: left; position: relative; }
        .big-char { font-size: 100px; color: var(--p); cursor: pointer; font-weight: bold; text-align: center; display: block; line-height: 1; margin: 10px 0; }
        
        .vocab-list { margin-top: 20px; border-top: 1px dashed #eee; padding-top: 15px; }
        .vocab-item { font-size: 1.4rem; margin: 12px 0; color: #2d3436; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .vocab-item:hover { color: var(--p); transform: translateX(5px); }
        .vocab-item:before { content: "ğŸ­"; margin-right: 10px; font-size: 1rem; }
        
        .tag { padding: 5px 15px; border-radius: 12px; color: white; font-size: 0.9rem; position: absolute; top: 20px; left: 20px; font-weight: bold; }
        
        #game-tab { display: none; }
        .quiz-card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(108, 92, 231, 0.1); }
        .opt-btn { width: 100%; padding: 18px; margin: 10px 0; font-size: 1.8rem; border: 2px solid #f1f2f6; border-radius: 15px; background: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .opt-btn:hover { background: #f1f2ff; border-color: var(--s); }

        .loading-spinner { color: #a4b0be; font-size: 1rem; font-style: italic; text-align: center; }
    </style>
</head>
<body>

<nav>
    <button id="nav-learn" class="active" onclick="showTab('learn')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
    <button id="nav-game" onclick="showTab('game')">ğŸ® æŒ‘æˆ°éŠæˆ²</button>
</nav>

<div class="container">
    <h2 id="date-info" style="color:#57606f; margin-bottom:20px;">è³‡æ–™æº–å‚™ä¸­...</h2>

    <div id="learn-tab">
        <div id="word-list" class="loading-spinner">âœ¨ æ­£åœ¨å¾é›²ç«¯è¾­å…¸å°‹æ‰¾å¥½è½çš„èªè©...</div>
    </div>

    <div id="game-tab">
        <div class="quiz-card">
            <div id="score" style="font-size: 1.2rem; color: #ffa502; font-weight: bold; margin-bottom: 10px;">ç²å¾—æ˜Ÿæ˜Ÿï¼š0 â­</div>
            <div id="q-text" style="font-size: 2rem; margin: 30px 0; min-height: 80px;"></div>
            <div id="q-options"></div>
        </div>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    let score = 0;
    let currentDayWords = [];
    let vocabCache = {}; // æš«å­˜æŠ“éçš„èªè©ï¼Œè®“éŠæˆ²æ¨¡å¼æ›´å¿«

    async function init() {
        try {
            const response = await fetch('schedule.json?v=' + Date.now());
            const scheduleData = await response.json();
            const today = new Date().toISOString().split('T')[0];
            
            // æŠ“å–ä»Šå¤©çš„å–®å­—
            const dateKey = scheduleData[today] ? today : Object.keys(scheduleData)[0];
            currentDayWords = scheduleData[dateKey];
            document.getElementById('date-info').innerText = "ğŸ“… " + dateKey + " ç·´ç¿’";
            
            renderLearn();
        } catch (e) {
            document.getElementById('word-list').innerHTML = "âŒ è®€å– schedule.json å¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆåç¨±ã€‚";
        }
    }

    // é—œéµä¿®æ­£ï¼šä½¿ç”¨ AllOrigins ä»£ç†ä¸¦è§£æ JSON
    async function fetchVocab(char) {
        if (vocabCache[char]) return vocabCache[char];
        
        try {
            const url = `https://www.moedict.tw/api/v2/index/${encodeURIComponent(char)}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            
            const response = await fetch(proxyUrl);
            const data = await response.json();
            const moedictData = JSON.parse(data.contents);
            
            const list = moedictData.relates || [];
            
            const result = {
                v2: list.filter(v => v.length === 2).slice(0, 3),
                v3: list.filter(v => v.length === 3).slice(0, 1),
                v4: list.filter(v => v.length >= 4).slice(0, 1)
            };
            
            // å¦‚æœ API çœŸçš„æ²’æ±è¥¿ï¼Œæ‰çµ¦äºˆæœ‰æ„ç¾©çš„å‚™æ¡ˆ
            if (result.v2.length === 0) result.v2 = [char + "å¤©", "å¤§" + char];
            
            vocabCache[char] = result;
            return result;
        } catch (e) {
            console.error("Fetch Error:", e);
            return { v2: [char + "å­"], v3: [], v4: [] };
        }
    }

    async function renderLearn() {
        const container = document.getElementById('word-list');
        let html = "";

        // æ”¹æˆé€å€‹è¼‰å…¥ï¼Œé¿å…ä¸€æ¬¡è«‹æ±‚éå¤šè¢«å°é–
        for (let i = 0; i < currentDayWords.length; i++) {
            const char = currentDayWords[i];
            const isNew = i < 2;
            const voc = await fetchVocab(char);

            html += `
                <div class="word-card">
                    <span class="tag" style="background:${isNew ? '#ff7675':'#55efc4'}">${isNew ? 'ä»Šæ—¥æ–°è©':'è¤‡ç¿’'}</span>
                    <div class="big-char" onclick="speak('${char}')">${char}</div>
                    <div class="vocab-list">
                        ${voc.v2.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                        ${voc.v3.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                        ${voc.v4.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                    </div>
                </div>
            `;
            // æ¯æŠ“å®Œä¸€å€‹å°±æ›´æ–°ä¸€æ¬¡ç•«é¢ï¼Œå¥³å…’å°±ä¸æœƒç­‰å¤ªä¹…
            container.innerHTML = html + "<p class='loading-spinner'>æ­£åœ¨æº–å‚™å¾Œé¢çš„å–®å­—...</p>";
        }
        container.innerHTML = html;
    }

    function showTab(tab) {
        document.getElementById('learn-tab').style.display = tab === 'learn' ? 'block' : 'none';
        document.getElementById('game-tab').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('nav-learn').className = tab === 'learn' ? 'active' : '';
        document.getElementById('nav-game').className = tab === 'game' ? 'active' : '';
        if(tab === 'game') initGame();
    }

    async function initGame() {
        const qText = document.getElementById('q-text');
        const qOpts = document.getElementById('q-options');
        qText.innerText = "ğŸ² é¡Œç›®æ­£åœ¨é£›éä¾†...";
        qOpts.innerHTML = "";

        const correctChar = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
        const voc = await fetchVocab(correctChar);
        const allVoc = [...voc.v2, ...voc.v3, ...voc.v4];

        if(allVoc.length === 0) { initGame(); return; }

        const target = allVoc[Math.floor(Math.random() * allVoc.length)];
        qText.innerHTML = `é€™å€‹å­—å¯ä»¥çµ„æˆï¼š<br><b style="font-size:3rem; color:var(--p);">${target.replace(correctChar, " â–¡ ")}</b>`;

        let options = [correctChar];
        while(options.length < 4) {
            let r = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === correctChar) {
                    score++;
                    document.getElementById('score').innerText = "ç²å¾—æ˜Ÿæ˜Ÿï¼š" + score + " â­";
                    speak("ç­”å°äº†ï¼Œå¦³çœŸæ£’ï¼");
                    initGame();
                } else {
                    speak("å†è©¦ä¸€æ¬¡");
                    btn.style.background = "#ffeaa7";
                }
            };
            qOpts.appendChild(btn);
        });
    }

    function speak(t) {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-TW';
        u.rate = 0.8;
        synth.speak(u);
    }

    init();
</script>
</body>
</html>
