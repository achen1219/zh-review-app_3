<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥³å…’çš„ä¸­æ–‡æ¢éšª</title>
    <style>
        :root { --p: #6c5ce7; --s: #a29bfe; --bg: #f9f9fb; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; text-align: center; }
        nav { background: white; padding: 15px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        nav button { padding: 10px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; background: #f1f2f6; color: #747d8c; }
        nav button.active { background: var(--p); color: white; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .word-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: left; }
        .big-char { font-size: 80px; color: var(--p); cursor: pointer; font-weight: bold; text-align: center; display: block; }
        
        .vocab-item { font-size: 1.2rem; margin: 8px 0; color: #444; cursor: pointer; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .tag { padding: 4px 10px; border-radius: 8px; color: white; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; }
        
        #game-tab { display: none; }
        .opt-btn { width: 100%; padding: 15px; margin: 8px 0; font-size: 1.5rem; border: 2px solid #ddd; border-radius: 12px; background: white; cursor: pointer; }

        /* é™¤éŒ¯å°è¦–çª—æ¨£å¼ */
        #debug-log { background: #fee; border: 1px solid #f88; padding: 10px; margin: 10px; border-radius: 10px; font-size: 0.8rem; text-align: left; display: none; }
    </style>
</head>
<body>

<nav>
    <button id="nav-learn" class="active" onclick="showTab('learn')">ğŸ“– å­¸ç¿’æ¨¡å¼</button>
    <button id="nav-game" onclick="showTab('game')">ğŸ® æŒ‘æˆ°éŠæˆ²</button>
</nav>

<div class="container">
    <div id="debug-log"></div>
    <h2 id="date-info">æ­£åœ¨æª¢æŸ¥è³‡æ–™...</h2>

    <div id="learn-tab">
        <div id="word-list">æ­£åœ¨è¼‰å…¥ä¸­...</div>
    </div>

    <div id="game-tab">
        <div style="background: white; padding: 30px; border-radius: 20px;">
            <div id="q-text" style="font-size: 1.8rem; margin-bottom: 20px;"></div>
            <div id="q-options"></div>
            <div id="score" style="margin-top: 20px; color: #ffa502; font-weight: bold;">â­ æ˜Ÿæ˜Ÿï¼š0</div>
        </div>
    </div>
</div>

<script>
    const synth = window.speechSynthesis;
    let score = 0;
    let currentDayWords = [];

    // é™¤éŒ¯å°å·¥å…·
    function log(msg, isError = false) {
        const logBox = document.getElementById('debug-log');
        logBox.style.display = 'block';
        logBox.innerHTML += `<div style="color:${isError?'red':'green'}">${new Date().toLocaleTimeString()}: ${msg}</div>`;
        console.log(msg);
    }

    async function init() {
        log("é–‹å§‹å˜—è©¦è®€å– schedule.json...");
        try {
            // å˜—è©¦æŠ“å– JSON
            const response = await fetch('schedule.json?v=' + Date.now()); // åŠ å…¥ç‰ˆæœ¬è™Ÿé¿å…å¿«å–
            if (!response.ok) throw new Error(`æ‰¾ä¸åˆ° schedule.json (ç‹€æ…‹ç¢¼: ${response.status})`);
            
            const scheduleData = await response.json();
            log("æˆåŠŸæŠ“å– JSON è³‡æ–™ï¼");

            const today = new Date().toISOString().split('T')[0];
            if (scheduleData[today]) {
                currentDayWords = scheduleData[today];
                document.getElementById('date-info').innerText = "ğŸ“… " + today;
            } else {
                const dates = Object.keys(scheduleData);
                const lastDate = dates[0];
                currentDayWords = scheduleData[lastDate];
                document.getElementById('date-info').innerText = "ğŸ“… é è¦½æ—¥æœŸï¼š" + lastDate;
                log(`ä»Šå¤©(${today})æ²’èª²ï¼Œæ”¹é¡¯ç¤º ${lastDate}`);
            }

            renderLearn();
        } catch (e) {
            log("ç™¼ç”ŸéŒ¯èª¤: " + e.message, true);
            document.getElementById('word-list').innerHTML = `<h3 style='color:red'>è®€å–å¤±æ•—ï¼š${e.message}</h3><p>è«‹ç¢ºèªæ‚¨çš„ GitHub å€‰åº«è£¡æ˜¯å¦æœ‰ schedule.json æª”æ¡ˆï¼Œä¸”æª”åå…¨ç‚ºå°å¯«ã€‚</p>`;
        }
    }

    async function fetchVocab(char) {
        try {
            // ç›´æ¥å‘¼å«èŒå…¸ API
            const response = await fetch(`https://www.moedict.tw/api/v2/index/${encodeURIComponent(char)}`);
            if (!response.ok) return { v2: [char+"å­"], v3: [], v4: [] };
            const data = await response.json();
            const list = data.relates || [];
            return {
                v2: list.filter(v => v.length === 2).slice(0, 3),
                v3: list.filter(v => v.length === 3).slice(0, 1),
                v4: list.filter(v => v.length >= 4).slice(0, 1)
            };
        } catch (e) {
            return { v2: [char+"å­"], v3: [], v4: [] };
        }
    }

    async function renderLearn() {
        const container = document.getElementById('word-list');
        container.innerHTML = "æ­£åœ¨æº–å‚™æ•™æï¼Œè«‹ç¨å€™...";
        
        let html = "";
        // ç‚ºäº†è§£æ±ºå¡ä½å•é¡Œï¼Œæˆ‘å€‘æ”¹ç”¨ã€ŒéåŒæ­¥å¹³è¡ŒæŠ“å–ã€æé«˜é€Ÿåº¦
        const vocabPromises = currentDayWords.map(char => fetchVocab(char));
        const allVocabs = await Promise.all(vocabPromises);

        for (let i = 0; i < currentDayWords.length; i++) {
            const char = currentDayWords[i];
            const isNew = i < 2;
            const voc = allVocabs[i];

            html += `
                <div class="word-card">
                    <span class="tag" style="background:${isNew ? '#ff7675':'#55efc4'}">${isNew ? 'ä»Šæ—¥æ–°è©':'è¤‡ç¿’'}</span>
                    <div class="big-char" onclick="speak('${char}')">${char}</div>
                    <div style="margin-top:10px;">
                        ${voc.v2.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                        ${voc.v3.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                        ${voc.v4.map(v => `<div class="vocab-item" onclick="speak('${v}')">${v}</div>`).join('')}
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
        log("æ•™ææ¸²æŸ“å®Œç•¢ï¼");
        // æ¸²æŸ“å®Œå¾Œéš±è—é™¤éŒ¯çª—ï¼ˆå¯é¸ï¼‰
        setTimeout(() => { document.getElementById('debug-log').style.display = 'none'; }, 3000);
    }

    // éŠæˆ²èˆ‡åˆ‡æ›åŠŸèƒ½ç¶­æŒä¸è®Š
    function showTab(tab) {
        document.getElementById('learn-tab').style.display = tab === 'learn' ? 'block' : 'none';
        document.getElementById('game-tab').style.display = tab === 'game' ? 'block' : 'none';
        document.getElementById('nav-learn').className = tab === 'learn' ? 'active' : '';
        document.getElementById('nav-game').className = tab === 'game' ? 'active' : '';
        if(tab === 'game') initGame();
    }

    async function initGame() {
        const qText = document.getElementById('q-text');
        const qOpts = document.getElementById('q-options');
        qText.innerText = "å‡ºé¡Œä¸­...";
        qOpts.innerHTML = "";
        const correctChar = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
        const voc = await fetchVocab(correctChar);
        const allVoc = [...voc.v2, ...voc.v3, ...voc.v4];
        if(allVoc.length === 0) { initGame(); return; }
        const target = allVoc[Math.floor(Math.random() * allVoc.length)];
        qText.innerHTML = `è«‹å¡«å…¥æ­£ç¢ºçš„å­—ï¼š<br><b style="font-size:2.5rem; color:var(--p);">${target.replace(correctChar, " â–¡ ")}</b>`;
        let options = [correctChar];
        while(options.length < 4) {
            let r = currentDayWords[Math.floor(Math.random() * currentDayWords.length)];
            if(!options.includes(r)) options.push(r);
        }
        options.sort(() => Math.random() - 0.5);
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === correctChar) { score++; document.getElementById('score').innerText = "â­ æ˜Ÿæ˜Ÿï¼š" + score; speak("ç­”å°äº†"); initGame(); }
                else { speak("å†è©¦ä¸€æ¬¡"); btn.style.background = "#ffeaa7"; }
            };
            qOpts.appendChild(btn);
        });
    }

    function speak(t) {
        if (synth.speaking) synth.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'zh-TW'; u.rate = 0.8; synth.speak(u);
    }

    init();
</script>
</body>
</html>
